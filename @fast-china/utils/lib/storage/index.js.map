{"version":3,"file":"index.js","sources":["../../../../src/storage/index.ts"],"sourcesContent":["import { computed, reactive } from \"vue\";\nimport { base64Util } from \"../base64\";\nimport { consoleError } from \"../console\";\nimport { FastError } from \"../error\";\n\nconst state = reactive({\n\tprefix: \"fast__\",\n\texpireSuffix: \"__Expire\",\n\tcrypto: false,\n});\n\n/**\n * 本地缓存前缀 Key\n */\nexport const CACHE_PREFIX = computed(() => state.prefix);\n\n/**\n * 本地缓存过期值后缀 Key\n */\nexport const CACHE_EXPIRE_SUFFIX = computed(() => state.expireSuffix);\n\n// eslint-disable-next-line @typescript-eslint/explicit-function-return-type, @typescript-eslint/explicit-module-boundary-types\nexport const useStorage = () => {\n\treturn {\n\t\t/**\n\t\t * 设置缓存前缀 Key\n\t\t * @param key\n\t\t */\n\t\tsetPrefix(key: string): void {\n\t\t\tstate.prefix = key;\n\t\t},\n\t\t/**\n\t\t * 缓存过期值后缀 Key\n\t\t * @param key\n\t\t */\n\t\tsetExpireSuffix(key: string): void {\n\t\t\tstate.expireSuffix = key;\n\t\t},\n\t\t/**\n\t\t * 设置缓存是否加密\n\t\t * @description 请在初始化的时候确认，后续不可再修改，否则所有数据都将失效\n\t\t * @param crypto\n\t\t */\n\t\tsetCrypto(crypto: boolean): void {\n\t\t\tstate.crypto = crypto;\n\t\t},\n\t};\n};\n\nconst storage = {\n\tset(key: string, val: any): void {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tuni.setStorageSync(key, val);\n\t\t} else {\n\t\t\twindow.localStorage.setItem(key, val);\n\t\t}\n\t},\n\tget(key: string): string | any | null {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\treturn uni.getStorageSync(key);\n\t\t} else {\n\t\t\treturn window.localStorage.getItem(key);\n\t\t}\n\t},\n\tremove(key: string): void {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tuni.removeStorageSync(key);\n\t\t} else {\n\t\t\twindow.localStorage.removeItem(key);\n\t\t}\n\t},\n\tclear(): void {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tuni.clearStorageSync();\n\t\t} else {\n\t\t\twindow.localStorage.clear();\n\t\t}\n\t},\n\tkeys(): string[] | Storage {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\treturn uni.getStorageInfoSync().keys;\n\t\t} else {\n\t\t\treturn window.localStorage;\n\t\t}\n\t},\n};\n\n/**\n * window.localStorage\n * - 如果是 UniApp 环境则使用的是 uni.xxxStorage\n */\nexport const Local = {\n\t/**\n\t * 设置\n\t * @param key 缓存的Key\n\t * @param val 缓存值\n\t * @param expire 过期时间，单位分钟\n\t * @param encrypt 是否对缓存的数据加密\n\t */\n\tset(key: string, val: any, expire?: number, encrypt?: boolean): void {\n\t\ttry {\n\t\t\tencrypt ??= state.crypto;\n\t\t\t// 判断是否存在缓存过期时间\n\t\t\tif (expire) {\n\t\t\t\tif (isNaN(expire) || expire < 1) {\n\t\t\t\t\tthrow new FastError(\"有效期应为一个有效数值\");\n\t\t\t\t}\n\t\t\t\t// 设置过期时间的缓存\n\t\t\t\tconst expireData = {\n\t\t\t\t\ttime: Date.now(),\n\t\t\t\t\texpire,\n\t\t\t\t};\n\t\t\t\tconst expireJson = JSON.stringify(expireData);\n\t\t\t\tstorage.set(`${state.prefix}${key}${state.expireSuffix}`, expireJson);\n\t\t\t}\n\t\t\tlet valJson = JSON.stringify(val);\n\t\t\tif (encrypt) {\n\t\t\t\tvalJson = base64Util.toBase64(valJson);\n\t\t\t}\n\t\t\tstorage.set(`${state.prefix}${key}`, valJson);\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Local\", error);\n\t\t}\n\t},\n\t/**\n\t * 获取\n\t * @param key 缓存的Key\n\t * @param decrypt 是否对缓存的数据解密\n\t * @returns {T} 传入的对象类型，默认为 string\n\t */\n\tget<T = string>(key: string, decrypt?: boolean): T {\n\t\ttry {\n\t\t\tdecrypt ??= state.crypto;\n\t\t\t// 获取缓存 JSON 字符串\n\t\t\tlet valJson = storage.get(`${state.prefix}${key}`);\n\n\t\t\tif (valJson) {\n\t\t\t\t// 判断是否解密\n\t\t\t\tif (decrypt) {\n\t\t\t\t\tvalJson = base64Util.base64ToStr(valJson);\n\t\t\t\t}\n\t\t\t\t// 尝试获取缓存过期时间的 JSON 字符串\n\t\t\t\tconst expireJson = storage.get(`${state.prefix}${key}${state.expireSuffix}`);\n\t\t\t\t// 判断是否存在过期时间\n\t\t\t\tif (expireJson) {\n\t\t\t\t\tconst expireData = JSON.parse(expireJson);\n\t\t\t\t\tif (Date.now() > expireData.time + expireData.expire * 60 * 1000) {\n\t\t\t\t\t\t// 过期了，删除对应的缓存数据\n\t\t\t\t\t\tstorage.remove(`${state.prefix}${key}`);\n\t\t\t\t\t\tstorage.remove(`${state.prefix}${key}${state.expireSuffix}`);\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttry {\n\t\t\t\t\treturn JSON.parse(valJson) as T;\n\t\t\t\t} catch {\n\t\t\t\t\treturn valJson as T;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Local\", error);\n\t\t}\n\t},\n\t/**\n\t * 移除\n\t * @param key 缓存的Key\n\t */\n\tremove(key: string): void {\n\t\ttry {\n\t\t\tstorage.remove(`${state.prefix}${key}`);\n\t\t\tstorage.remove(`${state.prefix}${key}${state.expireSuffix}`);\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Local\", error);\n\t\t}\n\t},\n\t/**\n\t * 根据前缀移除\n\t * @param key 缓存的Key\n\t */\n\tremoveByPrefix(key: string): void {\n\t\ttry {\n\t\t\tfor (const itemKey in storage.keys) {\n\t\t\t\tif (itemKey.indexOf(`${state.prefix}${key}`) !== -1) {\n\t\t\t\t\tstorage.remove(itemKey);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Local\", error);\n\t\t}\n\t},\n\t/**\n\t * 移除全部\n\t */\n\tclear(): void {\n\t\ttry {\n\t\t\tstorage.clear();\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Local\", error);\n\t\t}\n\t},\n};\n\n/**\n * window.sessionStorage\n * - UniApp 环境下不可用\n */\nexport const Session = {\n\t/**\n\t * 设置会话缓存\n\t * @param key 缓存的Key\n\t * @param val 缓存值\n\t * @param expire 过期时间，单位分钟\n\t * @param encrypt 是否对缓存的数据加密\n\t */\n\tset(key: string, val: any, expire?: number, encrypt?: boolean): void {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tconsoleError(\"Session\", \"UniApp 环境下 [Session] 不可用。\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tencrypt ??= state.crypto;\n\t\t\t// 判断是否存在缓存过期时间\n\t\t\tif (expire) {\n\t\t\t\tif (isNaN(expire) || expire < 1) {\n\t\t\t\t\tthrow new FastError(\"有效期应为一个有效数值\");\n\t\t\t\t}\n\t\t\t\t// 设置过期时间的缓存\n\t\t\t\tconst expireData = {\n\t\t\t\t\ttime: Date.now(),\n\t\t\t\t\texpire,\n\t\t\t\t};\n\t\t\t\tconst expireJson = JSON.stringify(expireData);\n\t\t\t\twindow.sessionStorage.setItem(`${state.prefix}${key}${state.expireSuffix}`, expireJson);\n\t\t\t}\n\t\t\tlet valJson = JSON.stringify(val);\n\t\t\tif (encrypt) {\n\t\t\t\tvalJson = base64Util.toBase64(valJson);\n\t\t\t}\n\t\t\twindow.sessionStorage.setItem(`${state.prefix}${key}`, valJson);\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Session\", error);\n\t\t}\n\t},\n\t/**\n\t * 获取会话缓存\n\t * @param key 缓存的Key\n\t * @param decrypt 是否对缓存的数据解密\n\t * @returns {T} 传入的对象类型，默认为 string\n\t */\n\tget<T = string>(key: string, decrypt?: boolean): T {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tconsoleError(\"Session\", \"UniApp 环境下 [Session] 不可用。\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tdecrypt ??= state.crypto;\n\t\t\t// 获取缓存 JSON 字符串\n\t\t\tlet valJson = window.sessionStorage.getItem(`${state.prefix}${key}`);\n\t\t\tif (valJson) {\n\t\t\t\t// 判断是否解密\n\t\t\t\tif (decrypt) {\n\t\t\t\t\tvalJson = base64Util.base64ToStr(valJson);\n\t\t\t\t}\n\t\t\t\t// 尝试获取缓存过期时间的 JSON 字符串\n\t\t\t\tconst expireJson = window.sessionStorage.getItem(`${state.prefix}${key}${state.expireSuffix}`);\n\t\t\t\t// 判断是否存在过期时间\n\t\t\t\tif (expireJson) {\n\t\t\t\t\tconst expireData = JSON.parse(expireJson);\n\t\t\t\t\tif (Date.now() > expireData.time + expireData.expire * 60 * 1000) {\n\t\t\t\t\t\t// 过期了，删除对应的缓存数据\n\t\t\t\t\t\twindow.sessionStorage.removeItem(`${state.prefix}${key}`);\n\t\t\t\t\t\twindow.sessionStorage.removeItem(`${state.prefix}${key}${state.expireSuffix}`);\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\ttry {\n\t\t\t\t\treturn JSON.parse(valJson) as T;\n\t\t\t\t} catch {\n\t\t\t\t\treturn valJson as T;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Session\", error);\n\t\t}\n\t},\n\t/**\n\t * 移除会话缓存\n\t * @param key 缓存的Key\n\t */\n\tremove(key: string): void {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tconsoleError(\"Session\", \"UniApp 环境下 [Session] 不可用。\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\twindow.sessionStorage.removeItem(`${state.prefix}${key}`);\n\t\t\twindow.sessionStorage.removeItem(`${state.prefix}${key}${state.expireSuffix}`);\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Session\", error);\n\t\t}\n\t},\n\t/**\n\t * 根据前缀移除会话缓存\n\t * @param key 缓存的Key\n\t */\n\tremoveByPrefix(key: string): void {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tconsoleError(\"Session\", \"UniApp 环境下 [Session] 不可用。\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tfor (const itemKey in window.sessionStorage) {\n\t\t\t\tif (itemKey.indexOf(`${state.prefix}${key}`) !== -1) {\n\t\t\t\t\twindow.sessionStorage.removeItem(itemKey);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Session\", error);\n\t\t}\n\t},\n\t/**\n\t * 移除全部会话缓存\n\t */\n\tclear(): void {\n\t\tif (typeof uni !== \"undefined\") {\n\t\t\tconsoleError(\"Session\", \"UniApp 环境下 [Session] 不可用。\");\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\twindow.sessionStorage.clear();\n\t\t} catch (error) {\n\t\t\tconsoleError(\"Session\", error);\n\t\t}\n\t},\n};\n"],"names":["state","reactive","prefix","expireSuffix","crypto","CACHE_PREFIX","computed","CACHE_EXPIRE_SUFFIX","storage","set","key","val","uni","setStorageSync","window","localStorage","setItem","get","getStorageSync","getItem","remove","removeStorageSync","removeItem","clear","clearStorageSync","keys","getStorageInfoSync","Local","expire","encrypt","isNaN","FastError","expireData","time","Date","now","expireJson","JSON","stringify","valJson","base64Util","toBase64","error","consoleError","decrypt","base64ToStr","parse","removeByPrefix","itemKey","indexOf","Session","sessionStorage","setPrefix","setExpireSuffix","setCrypto"],"mappings":"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"}